<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Guest's Shadow</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', Courier, monospace; }
        #ui { position: absolute; top: 20px; left: 20px; color: #ff0000; pointer-events: none; text-shadow: 2px 2px #000; }
        #overlay { 
            position: absolute; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); color: white; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10; cursor: pointer;
        }
        .battery-bar { width: 150px; height: 10px; border: 1px solid #fff; margin-top: 5px; }
        #battery-fill { width: 100%; height: 100%; background: #0f0; transition: width 0.2s; }
    </style>
</head>
<body>
    <div id="overlay">
        <h1>THE NEIGHBOR IS WATCHING</h1>
        <p>CLICK TO ENTER FULLSCREEN & START</p>
        <p style="font-size: 0.8em;">WASD to Move | F for Flashlight | ESC to Quit</p>
    </div>

    <div id="ui">
        <h2 id="time-display">TIME: DAY</h2>
        <div>FLASHLIGHT BATTERY</div>
        <div class="battery-bar"><div id="battery-fill"></div></div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- Core Setup ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // --- Lighting ---
        const sunLight = new THREE.DirectionalLight(0xffffff, 1.0);
        scene.add(sunLight);
        const ambient = new THREE.AmbientLight(0x404040, 0.5);
        scene.add(ambient);

        const flashlight = new THREE.SpotLight(0xffffff, 0, 40, Math.PI/6, 0.5);
        scene.add(flashlight);
        scene.add(flashlight.target);

        // --- World (Dark Forest/Yard) ---
        const floor = new THREE.Mesh(
            new THREE.PlaneGeometry(200, 200), 
            new THREE.MeshStandardMaterial({ color: 0x111111 })
        );
        floor.rotation.x = -Math.PI / 2;
        scene.add(floor);

        // --- The Guest (The Neighbor) ---
        const guestGroup = new THREE.Group();
        const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.5, 1.5, 4, 8), new THREE.MeshStandardMaterial({color: 0x222222}));
        guestGroup.add(body);
        guestGroup.position.set(20, 1.25, 20);
        scene.add(guestGroup);

        // --- Game Logic Variables ---
        let isNight = false;
        let flashlightOn = false;
        let battery = 100;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let yaw = 0, pitch = 0;
        
        // --- Interaction & Fullscreen ---
        const overlay = document.getElementById('overlay');
        overlay.addEventListener('click', () => {
            overlay.style.display = 'none';
            document.body.requestPointerLock();
            document.documentElement.requestFullscreen();
        });

        // --- Controls ---
        document.addEventListener('keydown', (e) => {
            if(e.code === 'KeyW') moveForward = true;
            if(e.code === 'KeyS') moveBackward = true;
            if(e.code === 'KeyA') moveLeft = true;
            if(e.code === 'KeyD') moveRight = true;
            if(e.code === 'KeyF' && battery > 0) toggleFlashlight();
        });
        document.addEventListener('keyup', (e) => {
            if(e.code === 'KeyW') moveForward = false;
            if(e.code === 'KeyS') moveBackward = false;
            if(e.code === 'KeyA') moveLeft = false;
            if(e.code === 'KeyD') moveRight = false;
        });
        document.addEventListener('mousemove', (e) => {
            if (document.pointerLockElement) {
                yaw -= e.movementX * 0.002;
                pitch -= e.movementY * 0.002;
                pitch = Math.max(-Math.PI/2.5, Math.min(Math.PI/2.5, pitch));
            }
        });

        function toggleFlashlight() {
            flashlightOn = !flashlightOn;
            flashlight.intensity = flashlightOn ? 100 : 0;
        }

        // --- Day/Night Timer (Now 30 seconds per cycle) ---
        setInterval(() => {
            isNight = !isNight;
            const display = document.getElementById('time-display');
            display.innerText = isNight ? "TIME: NIGHT" : "TIME: DAY";
            display.style.color = isNight ? "#ff0000" : "#ffffff";
            
            if (isNight) {
                scene.background = new THREE.Color(0x000000);
                sunLight.intensity = 0;
                guestGroup.scale.set(1.5, 3, 1.5); // He grows into a giant crowd/shadow
            } else {
                scene.background = new THREE.Color(0x445566);
                sunLight.intensity = 1.0;
                guestGroup.scale.set(1, 1, 1);
            }
        }, 30000); 

        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);

            // Movement logic
            const moveSpeed = 0.15;
            const direction = new THREE.Vector3();
            if (moveForward) direction.z -= 1;
            if (moveBackward) direction.z += 1;
            if (moveLeft) direction.x -= 1;
            if (moveRight) direction.x += 1;
            
            camera.rotation.order = "YXZ";
            camera.rotation.set(pitch, yaw, 0);
            camera.translateOnAxis(direction.normalize(), moveSpeed);
            camera.position.y = 1.7; // Player height

            // Flashlight tracking
            flashlight.position.copy(camera.position);
            const targetDir = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
            flashlight.target.position.copy(camera.position).add(targetDir);

            // Battery drain
            if (flashlightOn) {
                battery -= 0.05;
                if (battery <= 0) {
                    battery = 0;
                    flashlightOn = false;
                    flashlight.intensity = 0;
                }
                document.getElementById('battery-fill').style.width = battery + "%";
            }

            // AI Logic (Hello Guest style)
            const dist = guestGroup.position.distanceTo(camera.position);
            if (isNight) {
                // At night, he chases you aggressively
                const chaseDir = new THREE.Vector3().subVectors(camera.position, guestGroup.position).normalize();
                guestGroup.position.add(chaseDir.multiplyScalar(0.12));
                
                // If he gets close, he makes a "scratching" vibration (visual shake)
                if (dist < 5) {
                    camera.position.x += (Math.random() - 0.5) * 0.1;
                }
                
                if (dist < 1.5) {
                    alert("THE GUEST CAUGHT YOU");
                    location.reload();
                }
            } else {
                // In the day, he just wanders or stands still like a regular person
                guestGroup.position.x += Math.sin(Date.now() * 0.001) * 0.02;
            }

            renderer.render(scene, camera);
        }

        animate();
    </script>
</body>
</html>
